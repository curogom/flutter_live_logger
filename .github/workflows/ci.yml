name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.16.x'

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  analyze:
    name: ğŸ“Š Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
        
      - name: âœ¨ Verify Formatting
        run: dart format --output=none --set-exit-if-changed .
        
      - name: ğŸ” Analyze Project Source
        run: dart analyze --fatal-infos
        
      - name: ğŸ“‹ Check pub.dev Score
        run: |
          dart pub global activate pana
          pana --json --no-warning

  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Flutter í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ë©´ í™œì„±í™”)
  test:
    name: ğŸ§ª Run Tests  
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
        
      # Flutter í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ë©´ í™œì„±í™”
      # - name: ğŸ§ª Run Tests
      #   run: flutter test --coverage
      
      # - name: ğŸ“Š Upload Coverage to Codecov
      #   uses: codecov/codecov-action@v3
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     file: coverage/lcov.info
      #     fail_ci_if_error: true

  # í¬ë¡œìŠ¤ í”Œë«í¼ í˜¸í™˜ì„± ê²€ì‚¬ (Flutter í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ë©´ í™œì„±í™”)
  compatibility:
    name: ğŸ”§ Platform Compatibility
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
        
      # Flutter í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ë©´ í™œì„±í™”
      # - name: ğŸ§ª Run Tests
      #   run: flutter test
      
      # - name: ğŸ—ï¸ Build Example (Web)
      #   run: flutter build web --release
      #   working-directory: example
      #   if: matrix.os == 'ubuntu-latest'

  # ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬  
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
        
      # Flutter í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ë©´ í™œì„±í™”
      # - name: ğŸ”’ Run Security Audit
      #   run: |
      #     dart pub global activate security_audit
      #     security_audit

  # ë¬¸ì„œ ê²€ì¦
  docs:
    name: ğŸ“– Documentation Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ” Check Documentation Links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.github/workflows/markdown-link-check.json'
          
      - name: ğŸ“ Check Spelling
        uses: crate-ci/typos@master
        with:
          config: .github/workflows/typos.toml

  # ëª¨ë“  ì²´í¬ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
  all-checks-pass:
    name: âœ… All Checks Passed
    needs: [analyze, test, compatibility, security, docs]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ‰ All Checks Successful
        if: ${{ !(contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')) }}
        run: echo "ğŸŠ All quality checks passed successfully!"
        
      - name: âŒ Some Checks Failed  
        if: ${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}
        run: |
          echo "âŒ Some quality checks failed:"
          echo "Analyze: ${{ needs.analyze.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Compatibility: ${{ needs.compatibility.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Docs: ${{ needs.docs.result }}"
          exit 1 