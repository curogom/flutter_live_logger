name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/package-separation-v0.2.0 ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.x'

jobs:
  # í”„ë¡œì íŠ¸ êµ¬ì¡° ê²€ì¦
  structure-check:
    name: ğŸ” Monorepo Structure Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      core-package-exists: ${{ steps.check-packages.outputs.core-exists }}
      dashboard-package-exists: ${{ steps.check-packages.outputs.dashboard-exists }}
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ” Check Package Structure
        id: check-packages
        run: |
          # Core íŒ¨í‚¤ì§€ í™•ì¸
          if [ -f "packages/flutter_live_logger/pubspec.yaml" ]; then
            echo "core-exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Core package detected"
          else
            echo "core-exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Core package missing"
          fi
          
          # Dashboard íŒ¨í‚¤ì§€ í™•ì¸
          if [ -f "packages/flutter_live_logger_dashboard/pubspec.yaml" ]; then
            echo "dashboard-exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Dashboard package detected"
          else
            echo "dashboard-exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Dashboard package missing"
          fi
          
      - name: ğŸ“‹ Verify Monorepo Structure
        run: |
          echo "ğŸ“ Checking monorepo structure..."
          
          # í•„ìˆ˜ í”„ë¡œì íŠ¸ ë ˆë²¨ íŒŒì¼ë“¤ í™•ì¸
          required_files=(
            "LICENSE"
            "CONTRIBUTING.md"
            "CODE_OF_CONDUCT.md"
            ".gitignore"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done
          
          # íŒ¨í‚¤ì§€ ë””ë ‰í† ë¦¬ í™•ì¸
          if [ -d "packages" ]; then
            echo "âœ… packages/ directory exists"
          else
            echo "âŒ packages/ directory missing"
            exit 1
          fi
          
          echo "ğŸ‰ Monorepo structure verification passed!"

  # ë¬¸ì„œ ê²€ì¦ (íŒ¨í‚¤ì§€ë³„)
  docs-check:
    name: ğŸ“– Documentation Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: structure-check
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ” Check Core Package Documentation
        if: needs.structure-check.outputs.core-package-exists == 'true'
        run: |
          cd packages/flutter_live_logger
          echo "ğŸ“– Checking core package documentation..."
          
          required_docs=(
            "README.md"
            "README.ko.md"
            "CHANGELOG.md"
            "LICENSE"
          )
          
          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ… Core: $doc exists"
            else
              echo "âŒ Core: $doc missing"
              exit 1
            fi
          done
          
      - name: ğŸ” Check Dashboard Package Documentation
        if: needs.structure-check.outputs.dashboard-package-exists == 'true'
        run: |
          cd packages/flutter_live_logger_dashboard
          echo "ğŸ“– Checking dashboard package documentation..."
          
          required_docs=(
            "README.md"
            "README.ko.md"
            "CHANGELOG.md"
            "LICENSE"
          )
          
          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ… Dashboard: $doc exists"
            else
              echo "âŒ Dashboard: $doc missing"
              exit 1
            fi
          done

  # Core íŒ¨í‚¤ì§€ ë¶„ì„
  analyze-core:
    name: ğŸ“Š Core Package Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: structure-check
    if: needs.structure-check.outputs.core-package-exists == 'true'
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Install Core Dependencies
        run: |
          cd packages/flutter_live_logger
          flutter pub get
        
      - name: âœ¨ Verify Core Formatting
        run: |
          cd packages/flutter_live_logger
          dart format --output=none --set-exit-if-changed .
        
      - name: ğŸ” Analyze Core Package
        run: |
          cd packages/flutter_live_logger
          dart analyze --no-fatal-warnings

  # Dashboard íŒ¨í‚¤ì§€ ë¶„ì„
  analyze-dashboard:
    name: ğŸ“Š Dashboard Package Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: structure-check
    if: needs.structure-check.outputs.dashboard-package-exists == 'true'
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Install Dashboard Dependencies
        run: |
          cd packages/flutter_live_logger_dashboard
          flutter pub get
        
      - name: ğŸ§¹ Clean Dashboard build artifacts
        run: |
          cd packages/flutter_live_logger_dashboard
          flutter packages pub run build_runner clean
        
      - name: ğŸ”§ Generate Dashboard code
        run: |
          cd packages/flutter_live_logger_dashboard
          dart run build_runner build --delete-conflicting-outputs
        
      - name: âœ¨ Verify Dashboard Formatting
        run: |
          cd packages/flutter_live_logger_dashboard
          dart format --output=none --set-exit-if-changed .
        
      - name: ğŸ” Analyze Dashboard Package
        run: |
          cd packages/flutter_live_logger_dashboard
          dart analyze --no-fatal-warnings

  # Core íŒ¨í‚¤ì§€ í…ŒìŠ¤íŠ¸
  test-core:
    name: ğŸ§ª Core Package Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: structure-check
    if: needs.structure-check.outputs.core-package-exists == 'true'
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Install Core Dependencies
        run: |
          cd packages/flutter_live_logger
          flutter pub get
        
      - name: ğŸ§ª Run Core Tests
        run: |
          cd packages/flutter_live_logger
          flutter test --coverage --coverage-path=coverage/lcov.info
      
      - name: ğŸ“Š Upload Core Coverage
        uses: codecov/codecov-action@v3
        with:
          file: packages/flutter_live_logger/coverage/lcov.info
          flags: core
          name: core-coverage
          fail_ci_if_error: false
        continue-on-error: true

  # Dashboard íŒ¨í‚¤ì§€ í…ŒìŠ¤íŠ¸
  test-dashboard:
    name: ğŸ§ª Dashboard Package Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: structure-check
    if: needs.structure-check.outputs.dashboard-package-exists == 'true'
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Install Dashboard Dependencies
        run: |
          cd packages/flutter_live_logger_dashboard
          flutter pub get
        
      - name: ğŸ§¹ Clean Dashboard build artifacts for tests
        run: |
          cd packages/flutter_live_logger_dashboard
          flutter packages pub run build_runner clean
        
      - name: ğŸ”§ Generate Dashboard code for tests
        run: |
          cd packages/flutter_live_logger_dashboard
          dart run build_runner build --delete-conflicting-outputs
        
      - name: ğŸ§ª Run Dashboard Tests
        run: |
          cd packages/flutter_live_logger_dashboard
          flutter test --coverage --coverage-path=coverage/lcov.info
        continue-on-error: true
      
      - name: ğŸ“Š Upload Dashboard Coverage
        uses: codecov/codecov-action@v3
        with:
          file: packages/flutter_live_logger_dashboard/coverage/lcov.info
          flags: dashboard
          name: dashboard-coverage
          fail_ci_if_error: false
        continue-on-error: true

  # íŒ¨í‚¤ì§€ í˜¸í™˜ì„± ê²€ì‚¬
  package-validation:
    name: ğŸ“¦ Package Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [structure-check, analyze-core, analyze-dashboard]
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ—ï¸ Validate Core Package
        if: needs.structure-check.outputs.core-package-exists == 'true'
        run: |
          cd packages/flutter_live_logger
          flutter pub get
          echo "ğŸ“¦ Checking core package publishability..."
          dart pub publish --dry-run || echo "âš ï¸ Core publish dry-run issues found"
        continue-on-error: true
        
      - name: ğŸ—ï¸ Validate Dashboard Package
        if: needs.structure-check.outputs.dashboard-package-exists == 'true'
        run: |
          cd packages/flutter_live_logger_dashboard
          flutter pub get
          echo "ğŸ“¦ Checking dashboard package publishability..."
          dart pub publish --dry-run || echo "âš ï¸ Dashboard publish dry-run issues found"
        continue-on-error: true

  # Example í”„ë¡œì íŠ¸ í…ŒìŠ¤íŠ¸
  test-examples:
    name: ğŸš€ Example Projects Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [structure-check, test-core]
    if: needs.structure-check.outputs.core-package-exists == 'true'
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ§ª Test Core Example
        run: |
          if [ -d "packages/flutter_live_logger/example" ]; then
            cd packages/flutter_live_logger/example
            flutter pub get
            flutter analyze
            flutter test || echo "âš ï¸ Core example tests failed"
          fi
        continue-on-error: true
        
      - name: ğŸ§ª Test Root Example
        run: |
          if [ -f "example/pubspec.yaml" ]; then
            cd example
            flutter pub get
            flutter analyze
            echo "âœ… Root example project analyzed successfully"
          fi
        continue-on-error: true

  # ìµœì¢… ì„±ê³µ ì²´í¬
  all-checks-pass:
    name: âœ… All Checks Passed
    needs: [structure-check, docs-check, analyze-core, analyze-dashboard, test-core, test-dashboard, package-validation, test-examples]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ‰ All Checks Successful
        if: ${{ !(contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')) }}
        run: |
          echo "ğŸŠ All available quality checks passed successfully!"
          echo "ğŸ“¦ Monorepo structure: âœ…"
          echo "ğŸ“– Documentation: âœ…"
          echo "ğŸ” Code analysis: âœ…"
          echo "ğŸ§ª Tests: âœ…"
          echo "ğŸ“‹ Package validation: âœ…"
          echo ""
          echo "ğŸš€ Ready for deployment!" 