name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.16.x'

jobs:
  # í”„ë¡œì íŠ¸ ìƒíƒœ ì²´í¬
  project-check:
    name: ğŸ” Project Status Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      has-flutter-project: ${{ steps.check-flutter.outputs.has-project }}
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ” Check Flutter Project Exists
        id: check-flutter
        run: |
          if [ -f "pubspec.yaml" ]; then
            echo "has-project=true" >> $GITHUB_OUTPUT
            echo "âœ… Flutter project detected"
          else
            echo "has-project=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Flutter project not yet created - skipping Flutter-specific checks"
          fi

  # ë¬¸ì„œ ë° ê¸°ë³¸ êµ¬ì¡° ê²€ì¦ (í•­ìƒ ì‹¤í–‰)
  docs-and-structure:
    name: ğŸ“– Documentation & Structure Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ” Check Documentation Links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'yes'
          config-file: '.github/workflows/markdown-link-check.json'
          
      - name: ğŸ“ Check Spelling
        uses: crate-ci/typos@master
        with:
          config: .github/workflows/typos.toml
          
      - name: ğŸ“‹ Verify Project Structure
        run: |
          echo "ğŸ“ Checking project structure..."
          
          # í•„ìˆ˜ íŒŒì¼ë“¤ í™•ì¸
          required_files=(
            "README.md"
            "README.ko.md" 
            "LICENSE"
            "CONTRIBUTING.md"
            "CODE_OF_CONDUCT.md"
            "ROADMAP.md"
          )
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done
          
          # ë¬¸ì„œ ë””ë ‰í† ë¦¬ í™•ì¸
          if [ -d "doc" ]; then
            echo "âœ… doc/ directory exists"
          else
            echo "âŒ doc/ directory missing"
            exit 1
          fi
          
          echo "ğŸ‰ Project structure verification passed!"

  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (Flutter í”„ë¡œì íŠ¸ê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰)
  analyze:
    name: ğŸ“Š Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: project-check
    if: needs.project-check.outputs.has-flutter-project == 'true'
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
        
      - name: âœ¨ Verify Formatting
        run: dart format --output=none --set-exit-if-changed .
        
      - name: ğŸ” Analyze Project Source
        run: dart analyze
        
      - name: ğŸ“‹ Check pub.dev Score (Allow Failure)
        run: |
          dart pub global activate pana || true
          pana --json --no-warning || echo "âš ï¸ pana check failed, but continuing..."
        continue-on-error: true

  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Flutter í”„ë¡œì íŠ¸ê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰)
  test:
    name: ğŸ§ª Run Tests  
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: project-check
    if: needs.project-check.outputs.has-flutter-project == 'true'
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
        
      - name: ğŸ§ª Run Tests
        run: flutter test --coverage
      
      - name: ğŸ“Š Upload Coverage to Codecov (Optional)
        uses: codecov/codecov-action@v3
        with:
          file: coverage/lcov.info
          fail_ci_if_error: false
        continue-on-error: true

  # í”Œë«í¼ í˜¸í™˜ì„± ê²€ì‚¬ (ê°„ì†Œí™”)
  compatibility:
    name: ğŸ”§ Platform Compatibility
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: project-check
    if: needs.project-check.outputs.has-flutter-project == 'true'
    
    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ Install Dependencies
        run: flutter pub get
        
      - name: ğŸ§ª Run Tests
        run: flutter test
      
      - name: ğŸ—ï¸ Check Library Build (Dry Run)
        run: |
          echo "ğŸ“¦ Checking if library can be built..."
          flutter pub publish --dry-run || echo "âš ï¸ Publish dry-run issues found, but continuing..."
        continue-on-error: true

  # ëª¨ë“  ì²´í¬ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
  all-checks-pass:
    name: âœ… All Checks Passed
    needs: [project-check, docs-and-structure, analyze, test, compatibility]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ‰ All Checks Successful
        if: ${{ !(contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')) }}
        run: |
          echo "ğŸŠ All available quality checks passed successfully!"
          if [ "${{ needs.project-check.outputs.has-flutter-project }}" == "true" ]; then
            echo "âœ… Flutter project checks included"
          else
            echo "â„¹ï¸ Flutter project not yet created - basic structure checks only"
          fi
        
      - name: âŒ Some Checks Failed  
        if: ${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}
        run: |
          echo "âŒ Some quality checks failed - but this is normal during development:"
          echo "Project Check: ${{ needs.project-check.result }}"
          echo "Docs & Structure: ${{ needs.docs-and-structure.result }}"
          echo "Code Analysis: ${{ needs.analyze.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Compatibility: ${{ needs.compatibility.result }}"
          echo ""
          echo "ğŸ’¡ Focus on fixing failed checks step by step"
          exit 1 